name: Companion Build

on:
  workflow_dispatch:
  push:
    branches: [main]
    paths:
      - 'packages/companion/**'
  pull_request:
    branches: [main]
    paths:
      - 'packages/companion/**'

jobs:
  build-windows:
    name: Build Windows Installer
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 22

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 10

      - name: Install Rust stable
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: x86_64-pc-windows-msvc

      - name: Rust cache
        uses: swatinem/rust-cache@v2
        with:
          workspaces: packages/companion/src-tauri -> target

      - name: Install dependencies
        run: pnpm install

      - name: Generate icons
        run: node packages/companion/scripts/generate-icons.mjs

      - name: Build Tauri app
        uses: tauri-apps/tauri-action@v0
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          projectPath: packages/companion
          tauriScript: pnpm tauri

      - name: Upload MSI artifact
        uses: actions/upload-artifact@v4
        with:
          name: forgeai-companion-windows-msi
          path: packages/companion/src-tauri/target/release/bundle/msi/*.msi
          if-no-files-found: warn

      - name: Upload NSIS artifact
        uses: actions/upload-artifact@v4
        with:
          name: forgeai-companion-windows-nsis
          path: packages/companion/src-tauri/target/release/bundle/nsis/*.exe
          if-no-files-found: warn

  release:
    name: Create Release
    needs: build-windows
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v4

      - name: Download MSI artifact
        uses: actions/download-artifact@v4
        with:
          name: forgeai-companion-windows-msi
          path: artifacts/msi

      - name: Download NSIS artifact
        uses: actions/download-artifact@v4
        with:
          name: forgeai-companion-windows-nsis
          path: artifacts/nsis

      - name: Get version
        id: version
        run: echo "version=$(jq -r .version packages/companion/src-tauri/tauri.conf.json)" >> $GITHUB_OUTPUT

      - name: Generate changelog from commits
        id: changelog
        run: |
          # Get the previous tag to generate changelog since last release
          PREV_TAG=$(git tag --sort=-creatordate | grep '^v[0-9]' | head -n 2 | tail -n 1 || echo "")
          CURRENT_TAG="v${{ steps.version.outputs.version }}"

          echo "Previous tag: $PREV_TAG"
          echo "Current tag: $CURRENT_TAG"

          # Generate categorized changelog from commit messages
          if [ -n "$PREV_TAG" ]; then
            RANGE="${PREV_TAG}..HEAD"
          else
            RANGE="HEAD~50..HEAD"
          fi

          FEATS=$(git log $RANGE --pretty=format:"- %s" --grep="^feat" 2>/dev/null || echo "")
          FIXES=$(git log $RANGE --pretty=format:"- %s" --grep="^fix" 2>/dev/null || echo "")
          DOCS=$(git log $RANGE --pretty=format:"- %s" --grep="^docs" 2>/dev/null || echo "")
          OTHER=$(git log $RANGE --pretty=format:"- %s" --grep="^chore\|^refactor\|^ci\|^build" 2>/dev/null || echo "")

          # Build release body
          BODY="## ForgeAI $CURRENT_TAG"$'\n\n'

          if [ -n "$FEATS" ]; then
            BODY+="### âœ¨ New Features"$'\n'"$FEATS"$'\n\n'
          fi
          if [ -n "$FIXES" ]; then
            BODY+="### ðŸ› Bug Fixes"$'\n'"$FIXES"$'\n\n'
          fi
          if [ -n "$DOCS" ]; then
            BODY+="### ðŸ“ Documentation"$'\n'"$DOCS"$'\n\n'
          fi
          if [ -n "$OTHER" ]; then
            BODY+="### ðŸ”§ Infrastructure"$'\n'"$OTHER"$'\n\n'
          fi

          BODY+="---"$'\n\n'
          BODY+="### Installation"$'\n\n'
          BODY+='```bash'$'\n'
          BODY+="# Docker (recommended)"$'\n'
          BODY+="git clone https://github.com/forgeai-dev/ForgeAI.git && cd ForgeAI"$'\n'
          BODY+="docker compose up -d"$'\n\n'
          BODY+="# With custom domain + HTTPS"$'\n'
          BODY+="bash scripts/setup-domain.sh"$'\n'
          BODY+='```'$'\n\n'
          BODY+="### Companion (Windows Desktop Client)"$'\n\n'
          BODY+="Download the **.exe** or **.msi** installer from the assets below."$'\n'
          BODY+="Requirements: Windows 10/11 (64-bit), WebView2 Runtime"$'\n'

          # Write to file for the release action
          echo "$BODY" > release-body.md

      # IMPORTANT: Companion uses the unified project version tag (v1.2.0, v1.3.0, etc.)
      # NEVER create separate companion-specific tags (companion-v1.x.x).
      # The Companion is part of the monorepo and follows the same release lifecycle.
      - name: Upload to unified project release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: v${{ steps.version.outputs.version }}
          name: ForgeAI v${{ steps.version.outputs.version }}
          body_path: release-body.md
          files: |
            artifacts/msi/*
            artifacts/nsis/*
          draft: false
          prerelease: false
