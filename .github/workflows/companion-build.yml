name: Companion Build

on:
  workflow_dispatch:
  push:
    branches: [main]
    paths:
      - 'packages/companion/**'
  pull_request:
    branches: [main]
    paths:
      - 'packages/companion/**'

jobs:
  build-windows:
    name: Build Windows Installer
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 22

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 10

      - name: Install Rust stable
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: x86_64-pc-windows-msvc

      - name: Rust cache
        uses: swatinem/rust-cache@v2
        with:
          workspaces: packages/companion/src-tauri -> target

      - name: Install dependencies
        run: pnpm install

      - name: Generate icons
        run: node packages/companion/scripts/generate-icons.mjs

      - name: Build Tauri app
        uses: tauri-apps/tauri-action@v0
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          projectPath: packages/companion
          tauriScript: pnpm tauri

      - name: Upload MSI artifact
        uses: actions/upload-artifact@v4
        with:
          name: forgeai-companion-windows-msi
          path: packages/companion/src-tauri/target/release/bundle/msi/*.msi
          if-no-files-found: warn

      - name: Upload NSIS artifact
        uses: actions/upload-artifact@v4
        with:
          name: forgeai-companion-windows-nsis
          path: packages/companion/src-tauri/target/release/bundle/nsis/*.exe
          if-no-files-found: warn

  release:
    name: Create Release
    needs: build-windows
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v4

      - name: Download MSI artifact
        uses: actions/download-artifact@v4
        with:
          name: forgeai-companion-windows-msi
          path: artifacts/msi

      - name: Download NSIS artifact
        uses: actions/download-artifact@v4
        with:
          name: forgeai-companion-windows-nsis
          path: artifacts/nsis

      - name: Get version
        id: version
        run: echo "version=$(jq -r .version packages/companion/src-tauri/tauri.conf.json)" >> $GITHUB_OUTPUT

      - name: Upload Companion to unified project release
        uses: softprops/action-gh-release@v2
        with:
          # IMPORTANT: Companion uses the unified project version tag (v1.2.0, v1.3.0, etc.)
          # NEVER create separate companion-specific tags (companion-v1.x.x).
          # The Companion is part of the monorepo and follows the same release lifecycle.
          tag_name: v${{ steps.version.outputs.version }}
          name: ForgeAI v${{ steps.version.outputs.version }}
          body: |
            ## ForgeAI v${{ steps.version.outputs.version }}

            ### ForgeAI Companion (Windows Desktop Client)

            Lightweight native Windows assistant (~15MB) built with Tauri 2 + React + Rust.

            **Installation:**
            - **NSIS Installer** (.exe) — Recommended, includes auto-updater
            - **MSI Installer** (.msi) — Standard Windows installer

            **Requirements:**
            - Windows 10/11 (64-bit)
            - WebView2 Runtime (included in Windows 11, auto-installed on Windows 10)

            **Features:**
            - Dual environment routing (control server + Windows PC simultaneously)
            - Streaming heartbeat (no timeout on complex multi-step tasks)
            - Desktop automation (folders, files, apps, screenshots, shell commands)
            - Voice mode with wake word detection ("Hey Forge") + STT/TTS
            - Config Sync (transfer settings between Gateways)
            - Smart safety system (protects OS-critical paths)
            - Real-time agent progress via WebSocket
          files: |
            artifacts/msi/*
            artifacts/nsis/*
          draft: false
          prerelease: false
