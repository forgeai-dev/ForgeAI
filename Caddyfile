# ForgeAI — Caddy reverse proxy with automatic HTTPS
# This file is used when running with domain support enabled.
# Set DOMAIN in your .env file to your domain (e.g., ai.example.com)
#
# For subdomain support (sites/apps):
#   1. Add DNS wildcard: *.yourdomain.com → server IP
#   2. Enable subdomains in Dashboard → Settings → Domain & Sites

# Main domain — dashboard, API, WebSocket
{$DOMAIN:localhost} {
	reverse_proxy localhost:18800

	header {
		Strict-Transport-Security "max-age=31536000; includeSubDomains; preload"
		X-Frame-Options "SAMEORIGIN"
		X-Content-Type-Options "nosniff"
		X-XSS-Protection "1; mode=block"
		Referrer-Policy "strict-origin-when-cross-origin"
		-Server
	}

	@websocket {
		header Connection *Upgrade*
		header Upgrade websocket
	}
	reverse_proxy @websocket localhost:18800

	request_body {
		max_size 50MB
	}

	log {
		output stdout
		format console
	}
}

# Wildcard subdomains — agent-created sites and apps
# Caddy auto-generates HTTPS certificates for each subdomain via on-demand TLS.
# The Gateway reads the Host header and routes to the correct site/app.
*.{$DOMAIN:localhost} {
	tls {
		on_demand
	}

	reverse_proxy localhost:18800

	header {
		Strict-Transport-Security "max-age=31536000; includeSubDomains; preload"
		X-Content-Type-Options "nosniff"
		-Server
	}

	request_body {
		max_size 50MB
	}

	log {
		output stdout
		format console
	}
}
